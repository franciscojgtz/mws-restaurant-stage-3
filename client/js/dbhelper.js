"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var reviewsSource=null,DBHelper=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"fetchRestaurants",value:function(t){var n=this;this.showCachedRestaurants().then(function(e){void 0===e||0===e.length||(e.map(function(e){return e.source="cache",e}),console.log("restaurants from cache"),t(null,e)),n.getRestaurantsFromNetwork(t)}).catch(function(e){t("Request failed. Returned status of "+e,null)})}},{key:"getRestaurantsFromNetwork",value:function(t){fetch(a.DATABASE_URL).then(function(e){return e.json()}).then(function(e){a.placeRestaurantsIntoIDB(e),e.map(function(e){return e.source="network",e}),console.log("restaurants from network"),t(null,e)})}},{key:"fetchReviewsByRestaurantID",value:function(n,r){var o=this;console.log(n),"network"!==this.getReviewsSource&&(this.getReviewsFromNetwork(n,r),"cache"!==this.getReviewsSource&&this.showCachedReviewsByRestaurantID(n).then(function(t){o.getDeferedReviews().then(function(e){e.forEach(function(e){n===e.restaurant_id&&t.push(e)}),void 0===t||0===t.length||(console.log("reviews from cache"),t.map(function(e){return e.source="cache",e}),0<t.length&&(o.setReviewsSource="cache"),r(null,t))})}))}},{key:"getReviewsFromNetwork",value:function(e,t){var n=this;this.getDeferedReviews().then(function(e){e.forEach(function(e){n.postReview(e,function(e,t){console.log(t.restaurant_id),e?console.log(e):n.deleteDeferedReviewByRestaurantID(t.restaurant_id)})})}),fetch("http://localhost:1337/reviews/?restaurant_id="+e).then(function(e){return e.json()}).then(function(e){a.placeReviewsIntoIDB(e),console.log("reviews from network"),0<e.length&&(n.setReviewsSource="network"),e.map(function(e){return e.source="network",e}),t(null,e)})}},{key:"postReview",value:function(n,r){var o=this;fetch("http://localhost:1337/reviews/",{method:"post",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(n)}).then(function(e){return e.json()}).then(function(e){console.log("Success:",e),r(null,e)}).catch(function(e){console.error("Error:",e);var t=Date.now();n.createdAt=t,n.updatedAt=t,o.placedeferedReviewsIntoIDB(n),r(e,n)})}},{key:"deleteReview",value:function(e){fetch("http://localhost:1337/reviews/"+e,{method:"delete"}).then(function(e){console.log(e)})}},{key:"updateReview",value:function(e,t){fetch("http://localhost:1337/reviews/"+e,{method:"put",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(t)}).then(function(e){return e.json()}).catch(function(e){return console.error("Error:",e)}).then(function(e){return console.log("Success:",e)})}},{key:"updateIsFavortie",value:function(e,t,n){console.log(void 0===t?"undefined":_typeof(t)),console.log("http://localhost:1337/restaurants/"+e+"/?is_favorite="+t),fetch("http://localhost:1337/restaurants/"+e+"/?is_favorite="+t,{method:"put",headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(e){return e.json()}).catch(function(e){console.error("Error:",e),n(e,null)}).then(function(e){console.log("Success:",e),a.placeRestaurantIntoIDB(e),n(null,e)})}},{key:"fetchRestaurantById",value:function(t,n){var r=this;this.showCachedRestaurantByID(t).then(function(e){void 0===e||0===e.length||(console.log("restaurant from cache"),e.source="cache",n(null,e)),r.getRestaurantFromNetwork(t,n)})}},{key:"getRestaurantFromNetwork",value:function(e,t){fetch("http://localhost:1337/restaurants/"+e).then(function(e){return e.json()}).then(function(e){a.placeRestaurantIntoIDB(e),e.source="network",console.log("restaurant from network"),t(null,e)}).catch(function(e){return e})}},{key:"fetchRestaurantByCuisine",value:function(r,o){a.fetchRestaurants(function(e,t){if(e)o(e,null);else{var n=t.filter(function(e){return e.cuisine_type==r});o(null,n)}})}},{key:"fetchRestaurantByNeighborhood",value:function(r,o){a.fetchRestaurants(function(e,t){if(e)o(e,null);else{var n=t.filter(function(e){return e.neighborhood==r});o(null,n)}})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(r,o,u){a.fetchRestaurants(function(e,t){if(e)u(e,null);else{var n=t;"all"!=r&&(n=n.filter(function(e){return e.cuisine_type==r})),"all"!=o&&(n=n.filter(function(e){return e.neighborhood==o})),u(null,n)}})}},{key:"fetchNeighborhoods",value:function(o){a.fetchRestaurants(function(e,n){if(e)o(e,null);else{var r=n.map(function(e,t){return n[t].neighborhood}),t=r.filter(function(e,t){return r.indexOf(e)==t});o(null,t)}})}},{key:"fetchCuisines",value:function(o){a.fetchRestaurants(function(e,n){if(e)o(e,null);else{var r=n.map(function(e,t){return n[t].cuisine_type}),t=r.filter(function(e,t){return r.indexOf(e)==t});o(null,t)}})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return"/img/"+e.photograph+".jpg"}},{key:"mapMarkerForRestaurant",value:function(e,t){var n=new L.marker([e.latlng.lat,e.latlng.lng],{title:e.name,alt:e.name,url:a.urlForRestaurant(e)});return n.addTo(newMap),n}},{key:"openIDB",value:function(){return navigator.serviceWorker?idb.open("restaurants-reviews",3,function(e){switch(e.oldVersion){case 0:e.createObjectStore("restaurants",{keyPath:"id"});case 1:e.createObjectStore("reviews",{keyPath:"id"}).createIndex("restaurant","restaurant_id");case 2:e.createObjectStore("defered-reviews",{keyPath:"restaurant_id"})}}):Promise.resolve()}},{key:"placeRestaurantsIntoIDB",value:function(n){a.openIDB().then(function(e){if(e){var t=e.transaction("restaurants","readwrite").objectStore("restaurants");n.forEach(function(e){t.put(e)})}})}},{key:"placeRestaurantIntoIDB",value:function(t){a.openIDB().then(function(e){e&&e.transaction("restaurants","readwrite").objectStore("restaurants").put(t)})}},{key:"placeReviewsIntoIDB",value:function(n){a.openIDB().then(function(e){if(e){var t=e.transaction("reviews","readwrite").objectStore("reviews");n.forEach(function(e){t.put(e)})}})}},{key:"placedeferedReviewsIntoIDB",value:function(t){a.openIDB().then(function(e){e&&e.transaction("defered-reviews","readwrite").objectStore("defered-reviews").put(t)})}},{key:"showCachedRestaurants",value:function(){return a.openIDB().then(function(e){return e?e.transaction("restaurants").objectStore("restaurants").getAll().then(function(e){return e}):Promise.resolve()})}},{key:"showCachedRestaurantByID",value:function(t){return a.openIDB().then(function(e){return e?e.transaction("restaurants").objectStore("restaurants").get(parseInt(t)).then(function(e){return e}):Promise.resolve()})}},{key:"showCachedReviewsByRestaurantID",value:function(t){return a.openIDB().then(function(e){return e?e.transaction("reviews").objectStore("reviews").index("restaurant").getAll(t).then(function(e){return e}):Promise.resolve()})}},{key:"getDeferedReviews",value:function(){return a.openIDB().then(function(e){return e?e.transaction("defered-reviews").objectStore("defered-reviews").getAll().then(function(e){return e}):Promise.resolve()})}},{key:"deleteDeferedReviewByRestaurantID",value:function(r){return a.openIDB().then(function(e){if(!e)return Promise.resolve();var t=e.transaction("defered-reviews","readwrite"),n=t.objectStore("defered-reviews");return console.log(r),n.delete(r),t.complete}).then(function(){console.log("Deffered Review deleted from restaurant "+r)})}},{key:"getReviewsSource",get:function(){return reviewsSource}},{key:"setReviewsSource",set:function(e){reviewsSource=e}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337/restaurants"}}]),a}();